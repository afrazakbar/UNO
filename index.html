<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uno Card Game - Multiplayer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&amp;family=Nunito:wght@400;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }

    * {
      font-family: 'Nunito', sans-serif;
    }

    .uno-title {
      font-family: 'Fredoka One', cursive;
    }

    .card {
      width: 60px;
      height: 90px;
      border-radius: 8px;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transform-style: preserve-3d;
    }

    .card:hover:not(.card-back) {
      transform: translateY(-10px) scale(1.05);
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
      z-index: 100;
    }

    .card-inner {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 3px solid white;
      position: relative;
      overflow: hidden;
    }

    .card-red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .card-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .card-green { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
    .card-yellow { background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%); }
    .card-wild { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); }

    .card-oval {
      position: absolute;
      width: 85%;
      height: 140%;
      background: rgba(255,255,255,0.95);
      border-radius: 50%;
      transform: rotate(30deg);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-value {
      font-family: 'Fredoka One', cursive;
      font-size: 1.8rem;
      transform: rotate(-30deg);
      text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
    }

    .card-corner {
      position: absolute;
      font-family: 'Fredoka One', cursive;
      font-size: 0.6rem;
      color: white;
      text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
    }

    .card-corner-tl { top: 3px; left: 5px; }
    .card-corner-br { bottom: 3px; right: 5px; transform: rotate(180deg); }

    .card-back {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      cursor: default;
    }

    .card-back .card-inner {
      background: radial-gradient(ellipse at center, #ef4444 0%, #ef4444 30%, #000 30%, #000 35%, #eab308 35%, #eab308 65%, #000 65%, #000 70%, #22c55e 70%, #22c55e 100%);
    }

    .card-back-text {
      font-family: 'Fredoka One', cursive;
      color: white;
      font-size: 0.8rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      background: rgba(0,0,0,0.6);
      padding: 3px 6px;
      border-radius: 4px;
    }

    .wild-colors {
      position: absolute;
      width: 80%;
      height: 80%;
      border-radius: 50%;
      overflow: hidden;
    }

    .wild-quadrant {
      position: absolute;
      width: 50%;
      height: 50%;
    }

    .wild-quadrant:nth-child(1) { top: 0; left: 0; background: #ef4444; }
    .wild-quadrant:nth-child(2) { top: 0; right: 0; background: #3b82f6; }
    .wild-quadrant:nth-child(3) { bottom: 0; left: 0; background: #eab308; }
    .wild-quadrant:nth-child(4) { bottom: 0; right: 0; background: #22c55e; }

    .player-hand {
      display: flex;
      justify-content: center;
      gap: -20px;
      flex-wrap: nowrap;
      padding: 8px;
      max-width: 100%;
      overflow-x: auto;
    }

    .player-hand .card {
      margin-left: -20px;
    }

    .player-hand .card:first-child {
      margin-left: 0;
    }

    .draw-pile {
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .draw-pile:hover {
      transform: scale(1.05);
    }

    .color-picker {
      display: flex;
      gap: 12px;
      padding: 16px;
    }

    .color-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 4px solid white;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .color-btn:hover {
      transform: scale(1.15);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }

    .color-btn-red { background: #ef4444; }
    .color-btn-blue { background: #3b82f6; }
    .color-btn-green { background: #22c55e; }
    .color-btn-yellow { background: #eab308; }

    @keyframes cardDeal {
      from {
        opacity: 0;
        transform: translateY(-50px) rotate(90deg) scale(0.5);
      }
      to {
        opacity: 1;
        transform: translateY(0) rotate(0) scale(1);
      }
    }

    @keyframes cardPlay {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.2);
      }
      100% {
        transform: scale(1);
      }
    }

    .card-deal {
      animation: cardDeal 0.3s ease-out forwards;
    }

    .card-play {
      animation: cardPlay 0.3s ease-out;
    }

    .unplayable {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .unplayable:hover {
      transform: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .current-color-indicator {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 16px 32px;
      border-radius: 12px;
      font-size: 1.5rem;
      font-weight: bold;
      z-index: 1000;
      animation: toastPop 0.3s ease-out;
    }

    @keyframes toastPop {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    .game-table {
      background: radial-gradient(ellipse at center, #166534 0%, #14532d 50%, #052e16 100%);
      box-shadow: inset 0 0 100px rgba(0,0,0,0.5);
    }

    .uno-btn {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      font-family: 'Fredoka One', cursive;
      padding: 8px 20px;
      border-radius: 25px;
      border: 3px solid #fbbf24;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .uno-btn:hover:not(:disabled) {
      transform: scale(1.05);
    }

    .uno-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .mode-btn {
      background: linear-gradient(135deg, #ffffff 0%, #f3f4f6 100%);
      color: #1f2937;
      font-family: 'Fredoka One', cursive;
      padding: 20px 40px;
      border-radius: 20px;
      border: 4px solid #fbbf24;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.5rem;
      min-width: 280px;
    }

    .mode-btn:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 12px 24px rgba(0,0,0,0.4);
      border-color: #ef4444;
    }

    .home-screen {
      background: radial-gradient(ellipse at center, #dc2626 0%, #991b1b 50%, #7f1d1d 100%);
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(5deg); }
    }

    .floating-card {
      animation: float 3s ease-in-out infinite;
    }

    .floating-card:nth-child(2) { animation-delay: 0.5s; }
    .floating-card:nth-child(3) { animation-delay: 1s; }
    .floating-card:nth-child(4) { animation-delay: 1.5s; }

    .player-badge {
      background: rgba(0,0,0,0.5);
      border: 2px solid #fbbf24;
      border-radius: 12px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 120px;
    }

    .player-badge.active {
      border-color: #22c55e;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
    }

    .code-display {
      font-family: 'Fredoka One', cursive;
      font-size: 3rem;
      letter-spacing: 0.5rem;
      color: #fbbf24;
      text-shadow: 3px 3px 0 rgba(0,0,0,0.5);
    }

    input {
      font-family: 'Fredoka One', cursive;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.3rem;
    }

    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .connection-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: bold;
      z-index: 1000;
    }

    .connection-status.connected {
      background: #22c55e;
      color: white;
    }

    .connection-status.disconnected {
      background: #ef4444;
      color: white;
    }

    .connection-status.offline {
      background: #f59e0b;
      color: white;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full m-0 p-0 overflow-hidden"><!-- Connection Status -->
  <div id="connection-status" class="connection-status disconnected">
   ‚ö´ Connecting...
  </div><!-- Home Screen -->
  <div id="home-screen" class="h-full w-full home-screen flex flex-col items-center justify-center">
   <div class="text-center mb-12">
    <h1 class="uno-title text-8xl text-white drop-shadow-2xl mb-4">üé¥ UNO</h1>
    <p class="text-white text-2xl font-bold opacity-90">Online Multiplayer</p>
   </div><!-- Floating Cards -->
   <div class="absolute top-20 left-20 floating-card">
    <div class="card card-red">
     <div class="card-inner">
      <div class="card-oval"><span class="card-value" style="color: #dc2626;">7</span>
      </div>
     </div>
    </div>
   </div>
   <div class="absolute top-32 right-24 floating-card">
    <div class="card card-blue">
     <div class="card-inner">
      <div class="card-oval"><span class="card-value" style="color: #2563eb;">‚ü≤</span>
      </div>
     </div>
    </div>
   </div>
   <div class="absolute bottom-24 left-32 floating-card">
    <div class="card card-yellow">
     <div class="card-inner">
      <div class="card-oval"><span class="card-value" style="color: #ca8a04;">+2</span>
      </div>
     </div>
    </div>
   </div>
   <div class="absolute bottom-32 right-20 floating-card">
    <div class="card card-green">
     <div class="card-inner">
      <div class="card-oval"><span class="card-value" style="color: #16a34a;">5</span>
      </div>
     </div>
    </div>
   </div><!-- Mode Selection -->
   <div class="flex flex-col gap-6 z-10"><button id="create-game-btn" class="mode-btn"> üéÆ Create Game </button> <button id="join-game-btn" class="mode-btn"> üë• Join Game </button> <button id="play-ai-btn" class="mode-btn"> ü§ñ Play vs Computer </button>
   </div>
   <p class="text-white text-sm mt-8 opacity-70">Play with friends online or against AI ‚Ä¢ 2-6 players</p>
  </div><!-- Lobby Screen -->
  <div id="lobby-screen" class="h-full w-full home-screen flex-col items-center justify-center hidden">
   <div class="bg-black/50 rounded-3xl p-8 max-w-2xl w-full mx-4">
    <h2 class="uno-title text-4xl text-white text-center mb-6">Game Lobby</h2>
    <div id="game-code-section" class="text-center mb-8">
     <p class="text-white text-lg mb-2">Game Code:</p>
     <div class="code-display" id="lobby-game-code">
      XXXX
     </div>
     <p class="text-yellow-400 text-sm mt-2">Share this code with your friends!</p>
    </div>
    <div class="mb-6">
     <h3 class="text-white text-xl font-bold mb-3">Players:</h3>
     <div id="players-list" class="space-y-2"><!-- Players will be added here -->
     </div>
    </div>
    <div class="flex gap-4 justify-center"><button id="start-game-btn" class="uno-btn text-lg hidden">Start Game</button> <button id="leave-lobby-btn" class="uno-btn text-lg bg-gray-600">Leave</button>
    </div>
    <p class="text-white text-center text-sm mt-4 opacity-70">Waiting for players... (2-6 players needed)</p>
   </div>
  </div><!-- Join Screen -->
  <div id="join-screen" class="h-full w-full home-screen flex-col items-center justify-center hidden">
   <div class="bg-black/50 rounded-3xl p-8 max-w-md w-full mx-4">
    <h2 class="uno-title text-4xl text-white text-center mb-6">Join Game</h2>
    <div class="mb-6"><label for="player-name-input" class="text-white text-lg block mb-2">Your Name:</label> <input type="text" id="player-name-input" class="w-full px-4 py-3 rounded-lg text-lg border-4 border-yellow-400" placeholder="Enter your name" maxlength="12">
    </div>
    <div class="mb-6"><label for="game-code-input" class="text-white text-lg block mb-2">Game Code:</label> <input type="text" id="game-code-input" class="w-full px-4 py-3 rounded-lg text-2xl border-4 border-yellow-400" placeholder="XXXX" maxlength="4">
    </div>
    <div class="flex gap-4 justify-center"><button id="join-submit-btn" class="uno-btn text-lg">Join Game</button> <button id="cancel-join-btn" class="uno-btn text-lg bg-gray-600">Cancel</button>
    </div>
   </div>
  </div><!-- Game Screen -->
  <div id="game-screen" class="h-full w-full game-table flex-col hidden"><!-- Header -->
   <div class="flex justify-between items-center px-4 py-2">
    <div class="flex items-center gap-3"><button id="back-home-btn" class="text-white hover:text-yellow-400 transition-colors text-2xl"> ‚Üê </button>
     <h1 class="uno-title text-2xl text-white drop-shadow-lg">üé¥ UNO</h1>
    </div>
    <div class="flex items-center gap-4">
     <div class="flex items-center gap-2 bg-black/30 px-3 py-1 rounded-full"><span class="text-white text-sm font-bold">Color:</span>
      <div id="current-color" class="current-color-indicator bg-gray-500"></div>
     </div>
    </div>
   </div><!-- Players Grid -->
   <div class="flex-1 flex items-center justify-center relative"><!-- Other Players -->
    <div id="other-players-container" class="absolute top-4 left-0 right-0 flex justify-around px-4"><!-- Other players will be added here -->
    </div><!-- Center Game Area -->
    <div class="flex items-center gap-8"><!-- Draw Pile -->
     <div class="flex flex-col items-center gap-2">
      <div id="draw-pile" class="draw-pile card card-back">
       <div class="card-inner"><span class="card-back-text">UNO</span>
       </div>
      </div><span class="text-white text-xs font-bold bg-black/30 px-2 py-1 rounded">Draw</span>
     </div><!-- Discard Pile -->
     <div class="flex flex-col items-center gap-2">
      <div id="discard-pile" class="relative"><!-- Cards will be added here -->
      </div><span class="text-white text-xs font-bold bg-black/30 px-2 py-1 rounded">Discard</span>
     </div>
    </div>
   </div><!-- Current Player Area -->
   <div class="flex flex-col items-center py-2 pb-4">
    <div class="flex items-center gap-2 mb-2"><span id="current-player-label" class="text-white font-bold text-sm bg-black/30 px-3 py-1 rounded-full">üë§ You</span> <span id="current-player-count" class="bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">7</span> <button id="uno-btn" class="uno-btn text-xs" disabled>UNO!</button>
    </div>
    <div id="current-player-hand" class="player-hand"></div>
   </div><!-- Color Picker Modal -->
   <div id="color-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 rounded-2xl p-6 shadow-2xl">
     <h3 class="text-white text-xl font-bold mb-4 text-center">Choose a Color</h3>
     <div class="color-picker"><button class="color-btn color-btn-red" data-color="red"></button> <button class="color-btn color-btn-blue" data-color="blue"></button> <button class="color-btn color-btn-green" data-color="green"></button> <button class="color-btn color-btn-yellow" data-color="yellow"></button>
     </div>
    </div>
   </div><!-- Game Over Modal -->
   <div id="game-over-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl text-center">
     <h2 id="winner-text" class="uno-title text-4xl text-yellow-400 mb-4">Winner!</h2>
     <p id="winner-message" class="text-white text-lg mb-6">Congratulations!</p>
     <div class="flex gap-4 justify-center"><button id="back-to-home-btn" class="uno-btn text-lg">Back to Home</button>
     </div>
    </div>
   </div><!-- Turn Indicator -->
   <div id="turn-indicator" class="fixed bottom-4 left-4 bg-black/70 text-white px-4 py-2 rounded-full font-bold text-sm">
    Your Turn
   </div>
  </div>
  <script>
    // WebSocket connection
    let ws = null;
    let playerId = null;
    let playerName = '';
    let gameCode = null;
    let isHost = false;
    let gameState = null;
    let reconnectTimeout = null;
    let gameMode = null; // 'online' or 'ai'

    const WS_URL = 'ws://localhost:8765';
    const COLORS = ['red', 'blue', 'green', 'yellow'];
    const VALUES = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'skip', 'reverse', 'draw2'];

    // Generate unique player ID
    function generatePlayerId() {
      return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    playerId = generatePlayerId();

    // Connect to WebSocket
    function connectWebSocket() {
      try {
        ws = new WebSocket(WS_URL);

        ws.onopen = () => {
          console.log('Connected to server');
          updateConnectionStatus('connected');
        };

        ws.onmessage = (event) => {
          const message = JSON.parse(event.data);
          handleServerMessage(message);
        };

        ws.onclose = () => {
          console.log('Disconnected from server');
          updateConnectionStatus('disconnected');

          // Try to reconnect after 3 seconds
          reconnectTimeout = setTimeout(() => {
            console.log('Attempting to reconnect...');
            connectWebSocket();
          }, 3000);
        };

        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          updateConnectionStatus('disconnected');
        };
      } catch (error) {
        console.error('Failed to connect:', error);
        updateConnectionStatus('offline');
      }
    }

    // Update connection status indicator
    function updateConnectionStatus(status) {
      const statusEl = document.getElementById('connection-status');
      if (status === 'connected') {
        statusEl.className = 'connection-status connected';
        statusEl.textContent = 'üü¢ Online Mode';
      } else if (status === 'offline') {
        statusEl.className = 'connection-status offline';
        statusEl.textContent = 'üü° Offline Mode';
      } else {
        statusEl.className = 'connection-status disconnected';
        statusEl.textContent = 'üî¥ Disconnected';
      }
    }

    // Send message to server
    function sendMessage(type, data) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type, ...data }));
      }
    }

    // Handle server messages
    function handleServerMessage(message) {
      switch (message.type) {
        case 'game_created':
          gameCode = message.gameCode;
          isHost = true;
          showScreen('lobby-screen');
          document.getElementById('lobby-game-code').textContent = gameCode;
          document.getElementById('start-game-btn').classList.remove('hidden');
          break;

        case 'lobby_update':
          if (message.gameCode === gameCode) {
            updatePlayersLobby(message.players);
          }
          break;

        case 'game_joined':
          gameCode = message.gameCode;
          showScreen('lobby-screen');
          document.getElementById('lobby-game-code').textContent = gameCode;
          document.getElementById('start-game-btn').classList.add('hidden');
          break;

        case 'game_started':
          if (message.gameCode === gameCode) {
            gameState = message.gameState;
            gameMode = 'online';
            showScreen('game-screen');
            renderGame();
          }
          break;

        case 'game_update':
          if (message.gameCode === gameCode) {
            gameState = message.gameState;
            renderGame();
          }
          break;

        case 'game_over':
          if (message.gameCode === gameCode) {
            endGame(message.winner);
          }
          break;

        case 'error':
          showToast(message.message);
          break;
      }
    }

    // Screen Navigation
    function showScreen(screen) {
      const screens = ['home-screen', 'lobby-screen', 'join-screen', 'game-screen'];
      screens.forEach(s => {
        const el = document.getElementById(s);
        el.classList.toggle('hidden', s !== screen);
        el.classList.toggle('flex', s === screen);
      });
    }

    // Show toast
    function showToast(message, duration = 2000) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), duration);
    }

    // ==================== AI MODE ====================

    function startAIGame() {
      gameMode = 'ai';
      playerName = 'You';
      updateConnectionStatus('offline');

      // Create AI opponents
      const aiPlayers = [
        { id: 'ai1', name: 'ü§ñ Robot 1', isHost: false, hand: [], calledUno: false, isAI: true },
        { id: 'ai2', name: 'ü§ñ Robot 2', isHost: false, hand: [], calledUno: false, isAI: true },
        { id: 'ai3', name: 'ü§ñ Robot 3', isHost: false, hand: [], calledUno: false, isAI: true }
      ];

      const deck = shuffleDeck(createDeck());

      // Deal cards to all players
      const allPlayers = [
        { id: playerId, name: playerName, isHost: true, hand: [], calledUno: false, isAI: false },
        ...aiPlayers
      ];

      allPlayers.forEach(player => {
        player.hand = [];
        for (let i = 0; i < 7; i++) {
          player.hand.push(deck.pop());
        }
      });

      // Start discard pile
      let startCard = deck.pop();
      while (startCard.color === 'wild') {
        deck.insert(0, startCard);
        startCard = deck.pop();
      }

      gameState = {
        deck: deck,
        players: allPlayers,
        currentPlayerIndex: 0,
        discardPile: [startCard],
        currentColor: startCard.color,
        currentValue: startCard.value,
        direction: 1,
        hasDrawnThisTurn: false,
        winner: null
      };

      showScreen('game-screen');
      renderGame();
    }

    // AI makes a move
    function aiTurn() {
      if (gameMode !== 'ai') return;

      const currentPlayer = gameState.players[gameState.currentPlayerIndex];
      if (!currentPlayer.isAI) return;

      setTimeout(() => {
        // Find playable cards
        const playableCards = currentPlayer.hand.filter(card => isPlayable(card));

        if (playableCards.length > 0) {
          // Play a random playable card
          const card = playableCards[Math.floor(Math.random() * playableCards.length)];
          playCardAI(currentPlayer, card);
        } else {
          // Draw a card
          drawCardAI(currentPlayer);
        }
      }, 1000);
    }

    function playCardAI(player, card) {
      // Remove card from hand
      player.hand = player.hand.filter(c => c.id !== card.id);

      // Add to discard pile
      gameState.discardPile.push(card);

      // Handle wild cards
      if (card.color === 'wild') {
        // AI chooses a color (pick most common color in hand)
        const colorCounts = { red: 0, blue: 0, green: 0, yellow: 0 };
        player.hand.forEach(c => {
          if (c.color !== 'wild') colorCounts[c.color]++;
        });
        const chosenColor = Object.keys(colorCounts).reduce((a, b) =>
          colorCounts[a] > colorCounts[b] ? a : b
        );
        gameState.currentColor = chosenColor;
        gameState.currentValue = card.value;
      } else {
        gameState.currentColor = card.color;
        gameState.currentValue = card.value;
      }

      // Check for win
      if (player.hand.length === 0) {
        gameState.winner = player.name;
        endGame(player.name);
        return;
      }

      // Handle special cards
      handleSpecialCard(card);

      // Move to next player
      gameState.currentPlayerIndex = getNextPlayerIndex();
      gameState.hasDrawnThisTurn = false;

      renderGame();

      // Continue AI turns
      setTimeout(() => aiTurn(), 500);
    }

    function drawCardAI(player) {
      if (gameState.deck.length === 0) {
        reshuffleDeck();
      }

      if (gameState.deck.length > 0) {
        const card = gameState.deck.pop();
        player.hand.push(card);
      }

      // Move to next player
      gameState.currentPlayerIndex = getNextPlayerIndex();
      gameState.hasDrawnThisTurn = false;

      renderGame();

      // Continue AI turns
      setTimeout(() => aiTurn(), 500);
    }

    // ==================== DECK CREATION ====================

    function createDeck() {
      const deck = [];

      COLORS.forEach(color => {
        VALUES.forEach(value => {
          deck.push({ color, value, id: `${color}-${value}-1` });
          if (value !== '0') {
            deck.push({ color, value, id: `${color}-${value}-2` });
          }
        });
      });

      for (let i = 0; i < 4; i++) {
        deck.push({ color: 'wild', value: 'wild', id: `wild-${i}` });
        deck.push({ color: 'wild', value: 'wild4', id: `wild4-${i}` });
      }

      return deck;
    }

    function shuffleDeck(deck) {
      const shuffled = [...deck];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function reshuffleDeck() {
      const topCard = gameState.discardPile.pop();
      gameState.deck = shuffleDeck(gameState.discardPile);
      gameState.discardPile = [topCard];
    }

    function getNextPlayerIndex() {
      let nextIndex = gameState.currentPlayerIndex + gameState.direction;
      if (nextIndex >= gameState.players.length) nextIndex = 0;
      if (nextIndex < 0) nextIndex = gameState.players.length - 1;
      return nextIndex;
    }

    function handleSpecialCard(card) {
      switch(card.value) {
        case 'skip':
          showToast("Skip!");
          gameState.currentPlayerIndex = getNextPlayerIndex();
          break;
        case 'reverse':
          gameState.direction *= -1;
          showToast("Reverse!");
          if (gameState.players.length === 2) {
            gameState.currentPlayerIndex = getNextPlayerIndex();
          }
          break;
        case 'draw2':
          const nextIndex = getNextPlayerIndex();
          const nextPlayer = gameState.players[nextIndex];
          for (let i = 0; i < 2; i++) {
            if (gameState.deck.length > 0) {
              nextPlayer.hand.push(gameState.deck.pop());
            }
          }
          showToast(`${nextPlayer.name} draws +2`);
          gameState.currentPlayerIndex = nextIndex;
          break;
        case 'wild4':
          const nextIndex4 = getNextPlayerIndex();
          const nextPlayer4 = gameState.players[nextIndex4];
          for (let i = 0; i < 4; i++) {
            if (gameState.deck.length > 0) {
              nextPlayer4.hand.push(gameState.deck.pop());
            }
          }
          showToast(`${nextPlayer4.name} draws +4`);
          gameState.currentPlayerIndex = nextIndex4;
          break;
      }
    }

    // ==================== ONLINE MODE ====================

    // Create Game
    function createGame() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showToast('Not connected to server. Try AI mode!');
        return;
      }
      playerName = 'Host';
      gameMode = 'online';
      sendMessage('create_game', { playerId, playerName });
    }

    // Join Game
    function joinGame() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showToast('Not connected to server. Try AI mode!');
        return;
      }

      const name = document.getElementById('player-name-input').value.trim();
      const code = document.getElementById('game-code-input').value.trim().toUpperCase();

      if (!name) {
        showToast('Please enter your name');
        return;
      }

      if (code.length !== 4) {
        showToast('Please enter a 4-character game code');
        return;
      }

      playerName = name;
      gameMode = 'online';
      sendMessage('join_game', { playerId, playerName, gameCode: code });
    }

    // Update players lobby display
    function updatePlayersLobby(players) {
      const container = document.getElementById('players-list');
      container.innerHTML = '';

      players.forEach(player => {
        const div = document.createElement('div');
        div.className = 'bg-black/30 rounded-lg px-4 py-3 flex items-center gap-3';
        div.innerHTML = `
          <span class="text-2xl">${player.isHost ? 'üëë' : 'üë§'}</span>
          <span class="text-white font-bold text-lg">${player.name}</span>
          ${player.id === playerId ? '<span class="text-yellow-400 text-sm">(You)</span>' : ''}
        `;
        container.appendChild(div);
      });
    }

    // Leave lobby
    function leaveLobby() {
      if (gameCode && gameMode === 'online') {
        sendMessage('leave_game', { playerId, gameCode });
      }
      gameCode = null;
      isHost = false;
      showScreen('home-screen');
    }

    // Start Game
    function startGame() {
      if (!isHost) return;
      sendMessage('start_game', { playerId, gameCode });
    }

    // ==================== RENDERING ====================

    // Get card display value
    function getCardDisplayValue(value) {
      switch(value) {
        case 'skip': return '‚äò';
        case 'reverse': return '‚ü≤';
        case 'draw2': return '+2';
        case 'wild': return '‚ú¶';
        case 'wild4': return '+4';
        default: return value;
      }
    }

    function getCardColorClass(color) {
      switch(color) {
        case 'red': return 'card-red';
        case 'blue': return 'card-blue';
        case 'green': return 'card-green';
        case 'yellow': return 'card-yellow';
        default: return 'card-wild';
      }
    }

    function getTextColor(color) {
      switch(color) {
        case 'red': return '#dc2626';
        case 'blue': return '#2563eb';
        case 'green': return '#16a34a';
        case 'yellow': return '#ca8a04';
        default: return '#1f2937';
      }
    }

    // Create card element
    function createCardElement(card, isBack = false, isPlayable = true) {
      const cardEl = document.createElement('div');
      cardEl.className = `card ${isBack ? 'card-back' : getCardColorClass(card.color)} ${!isPlayable && !isBack ? 'unplayable' : ''}`;
      if (card.id) cardEl.dataset.cardId = card.id;

      if (isBack) {
        cardEl.innerHTML = `
          <div class="card-inner">
            <span class="card-back-text">UNO</span>
          </div>
        `;
      } else if (card.color === 'wild') {
        cardEl.innerHTML = `
          <div class="card-inner">
            <div class="wild-colors">
              <div class="wild-quadrant"></div>
              <div class="wild-quadrant"></div>
              <div class="wild-quadrant"></div>
              <div class="wild-quadrant"></div>
            </div>
            <span class="card-value" style="color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">${getCardDisplayValue(card.value)}</span>
          </div>
          <span class="card-corner card-corner-tl">${getCardDisplayValue(card.value)}</span>
          <span class="card-corner card-corner-br">${getCardDisplayValue(card.value)}</span>
        `;
      } else {
        cardEl.innerHTML = `
          <div class="card-inner">
            <div class="card-oval">
              <span class="card-value" style="color: ${getTextColor(card.color)};">${getCardDisplayValue(card.value)}</span>
            </div>
          </div>
          <span class="card-corner card-corner-tl">${getCardDisplayValue(card.value)}</span>
          <span class="card-corner card-corner-br">${getCardDisplayValue(card.value)}</span>
        `;
      }

      return cardEl;
    }

    // Check if card is playable
    function isPlayable(card) {
      if (!gameState) return false;
      if (card.color === 'wild') return true;
      if (card.color === gameState.currentColor) return true;
      if (card.value === gameState.currentValue) return true;
      return false;
    }

    // Render game
    function renderGame() {
      if (!gameState || !gameState.players) return;

      const currentPlayer = gameState.players.find(p => p.id === playerId);
      if (!currentPlayer) return;

      renderCurrentPlayerHand(currentPlayer);
      renderOtherPlayers();
      renderDiscardPile();
      updateColorIndicator();
      updateTurnIndicator();

      const isMyTurn = gameState.players[gameState.currentPlayerIndex].id === playerId;
      document.getElementById('uno-btn').disabled = currentPlayer.hand.length !== 2 || currentPlayer.calledUno || !isMyTurn;

      // Trigger AI turn if needed
      if (gameMode === 'ai' && gameState.players[gameState.currentPlayerIndex].isAI) {
        aiTurn();
      }
    }

    // Render current player hand
    function renderCurrentPlayerHand(player) {
      const container = document.getElementById('current-player-hand');
      container.innerHTML = '';

      document.getElementById('current-player-label').textContent = `üë§ ${player.name}`;
      document.getElementById('current-player-count').textContent = player.hand.length;

      const isMyTurn = gameState.players[gameState.currentPlayerIndex].id === playerId;

      player.hand.forEach((card, index) => {
        const playable = isMyTurn && isPlayable(card);
        const cardEl = createCardElement(card, false, playable);
        cardEl.style.animationDelay = `${index * 0.03}s`;
        cardEl.classList.add('card-deal');

        if (playable) {
          cardEl.addEventListener('click', () => playCard(card));
        }

        container.appendChild(cardEl);
      });
    }

    // Render other players
    function renderOtherPlayers() {
      const container = document.getElementById('other-players-container');
      container.innerHTML = '';

      const otherPlayers = gameState.players.filter(p => p.id !== playerId);

      otherPlayers.forEach((player) => {
        const playerIndex = gameState.players.findIndex(p => p.id === player.id);
        const isCurrentTurn = playerIndex === gameState.currentPlayerIndex;

        const div = document.createElement('div');
        div.className = 'flex flex-col items-center gap-2';

        const badge = document.createElement('div');
        badge.className = `player-badge ${isCurrentTurn ? 'active' : ''}`;
        badge.innerHTML = `
          <span class="text-lg">${player.isAI ? 'ü§ñ' : (player.isHost ? 'üëë' : 'üë§')}</span>
          <span class="text-white font-bold text-sm">${player.name}</span>
          <span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">${player.hand.length}</span>
        `;

        const handContainer = document.createElement('div');
        handContainer.className = 'flex gap-[-15px]';

        for (let i = 0; i < Math.min(player.hand.length, 10); i++) {
          const cardEl = createCardElement({}, true);
          cardEl.style.width = '40px';
          cardEl.style.height = '60px';
          cardEl.style.marginLeft = i > 0 ? '-15px' : '0';
          handContainer.appendChild(cardEl);
        }

        div.appendChild(badge);
        div.appendChild(handContainer);
        container.appendChild(div);
      });
    }

    // Render discard pile
    function renderDiscardPile() {
      const container = document.getElementById('discard-pile');
      container.innerHTML = '';

      if (gameState.discardPile.length > 0) {
        const topCard = gameState.discardPile[gameState.discardPile.length - 1];
        const cardEl = createCardElement(topCard);
        cardEl.classList.add('card-play');

        if (topCard.color === 'wild' && gameState.currentColor) {
          const overlay = document.createElement('div');
          overlay.className = 'absolute inset-0 rounded-lg opacity-30';
          overlay.style.backgroundColor = getTextColor(gameState.currentColor);
          cardEl.appendChild(overlay);
        }

        container.appendChild(cardEl);
      }
    }

    // Update color indicator
    function updateColorIndicator() {
      const indicator = document.getElementById('current-color');
      const colorMap = {
        red: '#ef4444',
        blue: '#3b82f6',
        green: '#22c55e',
        yellow: '#eab308'
      };
      indicator.style.backgroundColor = colorMap[gameState.currentColor] || '#6b7280';
    }

    // Update turn indicator
    function updateTurnIndicator() {
      const indicator = document.getElementById('turn-indicator');
      const currentPlayer = gameState.players[gameState.currentPlayerIndex];

      if (currentPlayer.id === playerId) {
        indicator.textContent = "Your Turn";
        indicator.style.backgroundColor = 'rgba(34, 197, 94, 0.8)';
      } else {
        indicator.textContent = `${currentPlayer.name}'s Turn`;
        indicator.style.backgroundColor = 'rgba(239, 68, 68, 0.8)';
      }
    }

    // ==================== PLAYER ACTIONS ====================

    // Play card
    function playCard(card) {
      const isMyTurn = gameState.players[gameState.currentPlayerIndex].id === playerId;
      if (!isMyTurn || !isPlayable(card)) return;

      if (gameMode === 'online') {
        if (card.color === 'wild') {
          window.pendingWildCard = card;
          showColorPicker();
          return;
        }
        sendMessage('play_card', { playerId, gameCode, cardId: card.id });
      } else {
        // AI mode
        const currentPlayer = gameState.players.find(p => p.id === playerId);
        currentPlayer.hand = currentPlayer.hand.filter(c => c.id !== card.id);
        gameState.discardPile.push(card);

        if (card.color === 'wild') {
          window.pendingWildCard = card;
          showColorPicker();
          return;
        }

        gameState.currentColor = card.color;
        gameState.currentValue = card.value;

        if (currentPlayer.hand.length === 0) {
          gameState.winner = currentPlayer.name;
          endGame(currentPlayer.name);
          return;
        }

        handleSpecialCard(card);
        gameState.currentPlayerIndex = getNextPlayerIndex();
        gameState.hasDrawnThisTurn = false;
        renderGame();
      }
    }

    // Show color picker
    function showColorPicker() {
      document.getElementById('color-modal').classList.remove('hidden');
    }

    // Select color
    function selectColor(color) {
      document.getElementById('color-modal').classList.add('hidden');

      if (gameMode === 'online' && window.pendingWildCard) {
        sendMessage('play_card', {
          playerId,
          gameCode,
          cardId: window.pendingWildCard.id,
          chosenColor: color
        });
        window.pendingWildCard = null;
      } else if (gameMode === 'ai' && window.pendingWildCard) {
        const card = window.pendingWildCard;
        const currentPlayer = gameState.players.find(p => p.id === playerId);

        gameState.currentColor = color;
        gameState.currentValue = card.value;

        if (currentPlayer.hand.length === 0) {
          gameState.winner = currentPlayer.name;
          endGame(currentPlayer.name);
          return;
        }

        if (card.value === 'wild4') {
          const nextIndex = getNextPlayerIndex();
          const nextPlayer = gameState.players[nextIndex];
          for (let i = 0; i < 4; i++) {
            if (gameState.deck.length > 0) {
              nextPlayer.hand.push(gameState.deck.pop());
            }
          }
          showToast(`${nextPlayer.name} draws +4`);
          gameState.currentPlayerIndex = nextIndex;
        }

        gameState.currentPlayerIndex = getNextPlayerIndex();
        gameState.hasDrawnThisTurn = false;
        window.pendingWildCard = null;
        renderGame();
      }
    }

    // Draw card
    function drawCard() {
      const isMyTurn = gameState.players[gameState.currentPlayerIndex].id === playerId;
      if (!isMyTurn) return;

      if (gameMode === 'online') {
        sendMessage('draw_card', { playerId, gameCode });
      } else {
        // AI mode
        const currentPlayer = gameState.players.find(p => p.id === playerId);

        if (gameState.hasDrawnThisTurn) {
          gameState.currentPlayerIndex = getNextPlayerIndex();
          gameState.hasDrawnThisTurn = false;
          renderGame();
          return;
        }

        if (gameState.deck.length === 0) {
          reshuffleDeck();
        }

        if (gameState.deck.length > 0) {
          const card = gameState.deck.pop();
          currentPlayer.hand.push(card);
          gameState.hasDrawnThisTurn = true;

          if (!isPlayable(card)) {
            showToast("Can't play. Click draw to pass.");
          } else {
            showToast("You can play the drawn card!");
          }
        }

        renderGame();
      }
    }

    // Call UNO
    function callUno() {
      if (gameMode === 'online') {
        sendMessage('call_uno', { playerId, gameCode });
      } else {
        const currentPlayer = gameState.players.find(p => p.id === playerId);
        if (currentPlayer && currentPlayer.hand.length === 2) {
          currentPlayer.calledUno = true;
          showToast(`${currentPlayer.name} calls UNO!`);
          renderGame();
        }
      }
    }

    // End game
    function endGame(winnerName) {
      const modal = document.getElementById('game-over-modal');
      const winnerText = document.getElementById('winner-text');
      const winnerMessage = document.getElementById('winner-message');

      winnerText.textContent = "üéâ Game Over!";
      winnerMessage.textContent = `${winnerName} wins!`;

      modal.classList.remove('hidden');
    }

    // Back to home
    function backToHome() {
      if (gameCode && gameMode === 'online') {
        sendMessage('leave_game', { playerId, gameCode });
      }

      gameCode = null;
      isHost = false;
      gameState = null;
      gameMode = null;
      document.getElementById('game-over-modal').classList.add('hidden');
      showScreen('home-screen');
    }

    // Event Listeners
    document.getElementById('create-game-btn').addEventListener('click', createGame);
    document.getElementById('join-game-btn').addEventListener('click', () => showScreen('join-screen'));
    document.getElementById('play-ai-btn').addEventListener('click', startAIGame);
    document.getElementById('join-submit-btn').addEventListener('click', joinGame);
    document.getElementById('cancel-join-btn').addEventListener('click', () => showScreen('home-screen'));
    document.getElementById('start-game-btn').addEventListener('click', startGame);
    document.getElementById('leave-lobby-btn').addEventListener('click', leaveLobby);
    document.getElementById('back-home-btn').addEventListener('click', backToHome);
    document.getElementById('back-to-home-btn').addEventListener('click', backToHome);
    document.getElementById('draw-pile').addEventListener('click', drawCard);
    document.getElementById('uno-btn').addEventListener('click', callUno);

    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.addEventListener('click', () => selectColor(btn.dataset.color));
    });

    // Initialize
    connectWebSocket();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c0729f6650f7f0c',t:'MTc2ODgzNDQzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
